
@model VSP_HealthExam.Web.EditModels.Document_BH_EditModel

@{
    ViewData["Title"] = "Create Document BH";
}

<div class="container">
    <div class="row" style="margin-bottom: 60px"></div>
    <div class="row">
        <div class="col-10">
            <h3>@Loc["OutVsp.CreateDocumentBH"]</h3>
        </div>
        <div class="col-2 text-end">
            <a class="btn btn-warning" asp-action="Index" asp-controller="NgoaiVSP" style="margin-bottom: 10px">@Loc["OutVsp.BacktoHomne"]</a>
        </div>
    </div>
<form id="formCreateDoc" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label asp-for="DanhSo">@Loc["OutVsp.CreateDanhSo"]</label>
        <input asp-for="DanhSo" class="form-control" readonly/>
        <input asp-for="DanhSo" class="form-control" type="hidden" />
        <span asp-validation-for="DanhSo" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="TenBenhVien">@Loc["OutVsp.Hospital"]</label>
        <input type="text" asp-for="TenBenhVien" class="form-control">
        <span asp-validation-for="TenBenhVien" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="ThongTin">@Loc["OutVsp.Info"]</label>
        <input type="text" asp-for="ThongTin" class="form-control">
        <span asp-validation-for="ThongTin" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="NgayBatDauKham">@Loc["OutVsp.StartDate"]</label>
        <input type="date" asp-for="NgayBatDauKham" class="form-control">
        <span asp-validation-for="NgayBatDauKham" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="NgayKetThucKham">@Loc["OutVsp.EndDate"]</label>
        <input type="date" asp-for="NgayKetThucKham" class="form-control">
        <span asp-validation-for="NgayKetThucKham" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="LoaiHinhDieuTri">@Loc["OutVsp.TypeOfTreatment"]</label>
        <input type="text" asp-for="LoaiHinhDieuTri" class="form-control">
        <span asp-validation-for="LoaiHinhDieuTri" class="text-danger"></span>
    </div>
        <div class="form-group">
            <label asp-for="HinhThucKCB">@Loc["OutVsp.FormOfMedical"]</label>
            <div class="form-check form-switch form-switch-lg text-success">
                <input type="checkbox" class="form-check-input" id="switchStatusHTKCB" @(Model.HinhThucKCB == "Ngoại trú" || Model.HinhThucKCB == "Амбулаторный" ? "checked" : "") />
                <input type="hidden" asp-for="HinhThucKCB" id="hiddenHTKCB" />
                <label class="form-check-label" for="switchStatusHTKCB" id="labelStatusHTKCB">
                    @(Model.HinhThucKCB == "Ngoại trú" ? Loc["OutVsp.Option_Outpatient"] : Model.HinhThucKCB == "Амбулаторный" ? Loc["OutVsp.Option_Outpatient"] : Model.HinhThucKCB == "Nội trú" ? Loc["OutVsp.Option_Inpatient"] : Loc["OutVsp.Option_Inpatient"])
                </label>
                <span asp-validation-for="HinhThucKCB" class="text-danger"></span>
            </div>
        </div>
        <div class="form-group">
            <label asp-for="DongYSuDung">@Loc["OutVsp.AgreeUseInfo"]</label>
            <div class="form-check form-switch form-switch-lg text-success">
                <input type="checkbox" class="form-check-input" id="switchStatus" @(Model.DongYSuDung == "Đồng ý" || Model.DongYSuDung == "Согласен" ? "checked" : "") />
                <input type="hidden" asp-for="DongYSuDung" id="hiddenDongYSuDung" />
                <label class="form-check-label" for="switchStatus" id="labelStatus">
                    @(Model.DongYSuDung == "Đồng ý" ? Loc["OutVsp.Option_Agree"] : Model.DongYSuDung == "Согласен" ? Loc["OutVsp.Option_Agree"] : Model.DongYSuDung == "Không" ? Loc["OutVsp.Option_Disagree"] : Loc["OutVsp.Option_Disagree"])
                </label>
                <span asp-validation-for="DongYSuDung" class="text-danger"></span>
            </div>
        </div>
    <div class="row">
            <div class="col">
                <label>@Loc["OutVsp.AddNewFile"]</label>
            </div>
            <label for="Files"> @Loc["OutVsp.AddNewFileDetail"]</label>
            <div class="col text-end">
                <span class="btn btn-icon btn-sm btn-rounded btn-primary" href="javascript:void(0)" id="addnewfile"
                      data-bs-toggle="tooltip" title="Add more files">
                    <span class="icon"><i class="fa fa-plus"></i></span>
                </span>
            </div>
        </div>
    <div class="row">
        <div class="col">
            <div class="form-group">
                    <label class="text-muted">@Loc["OutVsp.FileDescription"]</label>
                <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fa fa-file"></i></span>
                    <input asp-for="Descriptions" class="form-control form-control-sm"
                           placeholder="File name" />
                </div>
                <span asp-validation-for="Descriptions" class="text-danger"></span>
            </div>
        </div>
        <div class="col">
            <div class="form-group">
                    <label class="text-muted">@Loc["OutVsp.FileName"]</label>
                <div class="input-group input-group-sm">
                    <input type="file" asp-for="Files" class="form-control form-control-sm" accept="image/*,.pdf,.doc,.docx" style="display: none;" id="fileInput" />
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('fileInput').click()">
                        <span id="fileButtonText">@Loc["OutVsp.ChooseFile"]</span>
                    </button>
                    <span class="form-control form-control-sm" id="fileNameDisplay">@Loc["OutVsp.NoFileChosen"]</span>
                </div>
                <span asp-validation-for="Files" class="text-danger"></span>
            </div>
        </div>
            <div class="col-1" style="display: flex; align-items: center;">
                <span class="ms-2" >
                    <i class="fa fa-trash-alt text-danger" role="button" onclick="clearFirstRowData(this)" style="line-height: 2.5rem; vertical-align: middle; font-size: 1.2rem;"></i>
                </span>
        </div>
    </div>
    <div id="createmorefile">
    </div>

    <button type="submit" class="btn btn-primary">@Loc["OutVsp.Submit"]</button>
</form>
<!-- Thông báo kết quả -->
<div class="row mt-2">
    <div class="col-12">
        <div id="thongBaoCreateDoc" class="alert d-none" role="alert"></div>
    </div>
</div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            // Custom file input handling
            $('#fileInput').on('change', function() {
                var fileName = this.files[0] ? this.files[0].name : '';
                $('#fileNameDisplay').text(fileName || '@Loc["OutVsp.NoFileChosen"]');
            });
            $("#addnewfile").click(function () {
               $("#createmorefile").before(`
                   <div class="row mb-3">
                       <div class="col">
                            <div class="form-group">
                                <label class="text-muted">Mô tả</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="flag-icon flag-icon-ru"></i></span>
                                    <input name="Descriptions" class="form-control form-control-sm"
                                           placeholder="File name" />
                                </div>
                                <span asp-validation-for="FileNames" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="text-muted">SelectFile</label>
                                <input type="file" name="Files" class="form-control form-control-sm" accept="image/*,.pdf,.doc,.docx" />
                                <span asp-validation-for="Files" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-1" style="display: flex; align-items: center;">
                            <span class="ms-2"><i class="fa fa-trash-alt text-danger" role="button" onclick="removeRow(this)" style="line-height: 2.5rem; vertical-align: middle; font-size: 1.2rem;"></i></span>
                        </div>
                       </div>
               `)
            });
            window.removeRow = function (element) {
                                    $(element).closest('.row').remove();
            };
             // Handle switchStatus checkbox change for DongYSuDung
            $("#switchStatus").on("change", function () {
                var checkbox = $(this);
                var label = $("#labelStatus");
                var hiddenInput = $("#hiddenDongYSuDung");
                var language = $("html").attr("lang") || "vi"; // Default to Vietnamese
                if (checkbox.is(":checked")) {
                    label.html(language === "ru" ? "@Loc["OutVsp.Option_Agree"]" : "@Loc["OutVsp.Option_Agree"]");
                    hiddenInput.val(language === "ru" ? "Согласен" : "Đồng ý");
                } else {
                    label.html(language === "ru" ? "@Loc["OutVsp.Option_Disagree"]" : "@Loc["OutVsp.Option_Disagree"]");
                    hiddenInput.val(language === "ru" ? "Нет" : "Không");
                }
            });
             // Initialize checkbox and hidden input for DongYSuDung based on model value
            var initialValue = @Json.Serialize(Model.DongYSuDung);
            var language = $("html").attr("lang") || "vi"; // Default to Vietnamese
            if (initialValue === "Đồng ý" || initialValue === "Согласен") {
                $("#switchStatus").prop("checked", true);
                $("#labelStatus").html(language === "ru" ? "@Loc["OutVsp.Option_Agree"]" : "@Loc["OutVsp.Option_Agree"]");
                $("#hiddenDongYSuDung").val(language === "ru" ? "Согласен" : "Đồng ý");
            } else {
                $("#switchStatus").prop("checked", false);
                $("#labelStatus").html(language === "ru" ? "@Loc["OutVsp.Option_Disagree"]" : "@Loc["OutVsp.Option_Disagree"]");
                $("#hiddenDongYSuDung").val(language === "ru" ? "Нет" : "Không");
            }
             // Handle switchStatusHTKCB checkbox change for HinhThucKCB
            $("#switchStatusHTKCB").on("change", function () {
                var checkbox = $(this);
                var label = $("#labelStatusHTKCB");
                var hiddenInput = $("#hiddenHTKCB");
                var language = $("html").attr("lang") || "vi"; // Default to Vietnamese
                if (checkbox.is(":checked")) {
                    label.html(language === "ru" ? "@Loc["OutVsp.Option_Outpatient"]" : "@Loc["OutVsp.Option_Outpatient"]");
                    hiddenInput.val(language === "ru" ? "Амбулаторный" : "Ngoại trú");
                } else {
                    label.html(language === "ru" ? "@Loc["OutVsp.Option_Inpatient"]" : "@Loc["OutVsp.Option_Inpatient"]");
                    hiddenInput.val(language === "ru" ? "Стационарный" : "Nội trú");
                }
            });

            // Initialize checkbox and hidden input for HinhThucKCB based on model value
            var initialValueHTKCB = @Json.Serialize(Model.HinhThucKCB);
            if (initialValueHTKCB === "Ngoại trú" || initialValueHTKCB === "Амбулаторный") {
                $("#switchStatusHTKCB").prop("checked", true);
                $("#labelStatusHTKCB").html(language === "ru" ? "@Loc["OutVsp.Option_Outpatient"]" : "@Loc["OutVsp.Option_Outpatient"]");
                $("#hiddenHTKCB").val(language === "ru" ? "Амбулаторный" : "Ngoại trú");
            } else {
                $("#switchStatusHTKCB").prop("checked", false);
                $("#labelStatusHTKCB").html(language === "ru" ? "@Loc["OutVsp.Option_Inpatient"]" : "@Loc["OutVsp.Option_Inpatient"]");
                $("#hiddenHTKCB").val(language === "ru" ? "Стационарный" : "Nội trú");
            }
            $('#formCreateDoc').submit(function(e) {
                e.preventDefault();
                var form = $(this)[0];
                var formData = new FormData(form);
                $.ajax({
                    url: '@Url.Action("CreateDocument_BH", "NgoaiVSP")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            showThongBaoCreateDoc(response.message || 'Tạo hồ sơ thành công!', true);
                            setTimeout(function(){ window.location.href = '@Url.Action("Index", "NgoaiVSP")'; }, 1500);
                        } else {
                            let msg = response.message || 'Có lỗi xảy ra!';
                            if (response.errors && response.errors.length > 0) {
                                msg += '<ul>' + response.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
                            }
                            showThongBaoCreateDoc(msg, false);
                        }
                    },
                    error: function(xhr) {
                        let msg = 'Có lỗi xảy ra khi tạo hồ sơ!';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            msg = xhr.responseJSON.message;
                        }
                        if (xhr.responseJSON && xhr.responseJSON.errors && xhr.responseJSON.errors.length > 0) {
                            msg += '<ul>' + xhr.responseJSON.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
                        }
                        showThongBaoCreateDoc(msg, false);
                    }
                });
            });
            function showThongBaoCreateDoc(message, isSuccess) {
                var alertDiv = $('#thongBaoCreateDoc');
                alertDiv.removeClass('d-none alert-success alert-danger');
                alertDiv.addClass(isSuccess ? 'alert-success' : 'alert-danger');
                alertDiv.html(message);
                alertDiv.show();
                if (isSuccess) {
                    setTimeout(function () {
                        alertDiv.fadeOut(500, function () {
                            alertDiv.addClass('d-none').removeClass('alert-success alert-danger').html('');
                        });
                    }, 1500);
                }
            }
        });
        function clearFirstRowData(element) {
                        // Find the closest .row ancestor
                        var row = $(element).closest('.row');
                        // Clear the FileName input
                        row.find('input[name="FileNames"]').val('');
                        // Clear the file input
                        row.find('input[type="file"]').val('');
         };
       
    </script>
}

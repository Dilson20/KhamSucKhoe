@model VSP_HealthExam.Web.EditModels.Document_BH_EditModel

@{
    ViewData["Title"] = "Admin Update Document BH";
}

<div class="container">
    <div class="row" style="margin-bottom: 60px"></div>
    <div class="row">
        <div class="col-10">
            <h2>Điều chỉnh thông tin hồ sơ</h2>
        </div>
        <div class="col-2 text-end">
            <a class="btn btn-warning" asp-action="AdminIndex" asp-controller="NgoaiVSP" style="margin-bottom: 10px">Quay lại</a>
        </div>
    </div>
    <form id="formAdminUpdateDoc" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <input asp-for="Id" class="form-control" hidden />
        </div>
        <div class="form-group">
            <label asp-for="DanhSo"></label>
            <input asp-for="DanhSo" class="form-control" readonly />
            <input asp-for="DanhSo" class="form-control" type="hidden" />
            <span asp-validation-for="DanhSo" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="TenBenhVien"></label>
            <input type="text" asp-for="TenBenhVien" class="form-control" readonly>
            <span asp-validation-for="TenBenhVien" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="ThongTin"></label>
            <input type="text" asp-for="ThongTin" class="form-control" readonly>
            <span asp-validation-for="ThongTin" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="NgayBatDauKham"></label>
            <input type="date" asp-for="NgayBatDauKham" class="form-control" readonly>
            <span asp-validation-for="NgayBatDauKham" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="NgayKetThucKham"></label>
            <input type="date" asp-for="NgayKetThucKham" class="form-control" readonly>
            <span asp-validation-for="NgayKetThucKham" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="LoaiHinhDieuTri">Phương pháp điều trị</label>
            <input type="text" asp-for="LoaiHinhDieuTri" class="form-control" readonly>
            <span asp-validation-for="LoaiHinhDieuTri" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="DongYSuDung"></label>
            <div class="form-check form-switch form-switch-lg text-success">
                <input type="checkbox" class="form-check-input" id="switchStatus" @(Model.DongYSuDung == "1" ? "checked" : "") disabled/>
                <input type="hidden" asp-for="DongYSuDung" id="hiddenDongYSuDung" />
                <label class="form-check-label" for="switchStatus" id="labelStatus">
                    @(Model.DongYSuDung == "1" ? "Đồng ý" : "Không")
                </label>
                <span asp-validation-for="DongYSuDung" class="text-danger"></span>
            </div>
        </div>
       
        <div class="row ">
            @foreach (var file in Model.FilesAttachments)
            {
                <div class="row">
                    <input type="hidden" asp-for="@file.Id" />
                    <div class="col">
                        <div class="form-group">
                            <label class="text-muted">Tên file</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="flag-icon flag-icon-vn"></i></span>
                                <input asp-for="@file.Description" class="form-control form-control-sm"
                                       placeholder="File name" readonly />
                                <input asp-for="@file.Description" class="form-control form-control-sm"
                                       placeholder="File name" type="hidden" />
                            </div>

                            <span asp-validation-for="FileNames" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label class="text-muted">Hiển thị file</label>
                            <div class="input-group input-group-sm">
                                <a href="/Documents/UploadFile/@file.FileName" target="_blank"><em>@file.FileName</em></a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div>
            <h3>Thực hiện bởi TTYT</h3>
        </div>
        <div class="form-group">
            <label asp-for="NoteByDoctor"></label>
            <input type="text" asp-for="NoteByDoctor" class="form-control">
            <span asp-validation-for="NoteByDoctor" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Status"></label>
            <select type="text" asp-for="Status" asp-items="ViewBag.Status" class="form-control">
            </select>
            <span asp-validation-for="Status" class="text-danger"></span>
        </div>
        <div class="row">
            <div class="col">
                <label>Thêm file đã ký khi hồ sơ hoàn thành</label>  
            </div>
        </div>
        <div class="row"> 
            <div class="col">
                <div class="form-group">
                    <label class="text-muted">SelectFile</label>
                    <input type="file" asp-for="Files" class="form-control form-control-sm" accept="audio/*,video/*,image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar" />
                    <span asp-validation-for="Files" class="text-danger"></span>
                </div>
            </div>
            <div class="col-1" style="display: flex; align-items: center;">
                <span class="ms-2">
                    <i class="fa fa-trash-alt text-danger" role="button" onclick="clearFirstRowData(this)" style="line-height: 2.5rem; vertical-align: middle; font-size: 1.2rem;"></i>
                </span>
            </div>
        </div>
        <div id="createmorefile">
        </div>
        <div class="row">
            <div class="col-2">
                <button type="submit" class="btn btn-primary">Hoàn thành</button>
            </div>
           
            <div class="col-2">
                <button class="btn btn-primary" id="downloadasExcelforOneUser">Xuất file theo cá nhân</button>
            </div>
        </div>
        
    </form>
    <!-- Thông báo kết quả -->
    <div class="row mt-2">
        <div class="col-12">
            <div id="thongBaoAdminUpdateDoc" class="alert d-none" role="alert"></div>
        </div>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function(){

            // Handle switchStatus checkbox change
            $("#switchStatus").on("change", function () {
                var checkbox = $(this);
                var label = $("#labelStatus");
                var hiddenInput = $("#hiddenDongYSuDung");
                if (checkbox.is(":checked")) {
                    label.text("Đồng ý");
                    hiddenInput.val("1");
                } else {
                    label.text("Không");
                    hiddenInput.val("0");
                }
            });

            // Initialize checkbox and hidden input based on model value
            var initialValue = @Json.Serialize(Model.DongYSuDung);
            if (initialValue === "1") {
                $("#switchStatus").prop("checked", true);
                $("#labelStatus").text("Đồng ý");
                $("#hiddenDongYSuDung").val("1");
            } else {
                $("#switchStatus").prop("checked", false);
                $("#labelStatus").text("Không");
                $("#hiddenDongYSuDung").val("0");
            }

            $('#formAdminUpdateDoc').submit(function(e) {
                e.preventDefault();
                var form = $(this)[0];
                var formData = new FormData(form);
                $.ajax({
                    url: '@Url.Action("AdminUpdateDocument_BH", "NgoaiVSP")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            showThongBaoAdminUpdateDoc(response.message || 'Cập nhật hồ sơ thành công!', true);
                            setTimeout(function(){ window.location.href = '@Url.Action("AdminIndex", "NgoaiVSP")'; }, 1500);
                        } else {
                            let msg = response.message || 'Có lỗi xảy ra!';
                            if (response.errors && response.errors.length > 0) {
                                msg += '<ul>' + response.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
                            }
                            showThongBaoAdminUpdateDoc(msg, false);
                        }
                    },
                    error: function(xhr) {
                        let msg = 'Có lỗi xảy ra khi cập nhật hồ sơ!';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            msg = xhr.responseJSON.message;
                        }
                        if (xhr.responseJSON && xhr.responseJSON.errors && xhr.responseJSON.errors.length > 0) {
                            msg += '<ul>' + xhr.responseJSON.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
                        }
                        showThongBaoAdminUpdateDoc(msg, false);
                    }
                });
            });
            function showThongBaoAdminUpdateDoc(message, isSuccess) {
                var alertDiv = $('#thongBaoAdminUpdateDoc');
                alertDiv.removeClass('d-none alert-success alert-danger');
                alertDiv.addClass(isSuccess ? 'alert-success' : 'alert-danger');
                alertDiv.html(message);
                alertDiv.show();
                if (isSuccess) {
                    setTimeout(function () {
                        alertDiv.fadeOut(500, function () {
                            alertDiv.addClass('d-none').removeClass('alert-success alert-danger').html('');
                        });
                    }, 1500);
                }
            }
        });
        function clearFirstRowData(element) {
                        // Find the closest .row ancestor
                        var row = $(element).closest('.row');
                        // Clear the FileName input
                        row.find('input[name="FileNames"]').val('');
                        // Clear the file input
                        row.find('input[type="file"]').val('');
         };
        function deleteRow(element, fileId) {
                    // Remove the file row from the UI
                    $(element).closest('.row').remove();

                    // Optionally, add a hidden input to mark the file for deletion on server post
                    var deletedFilesInput = $('<input>')
                        .attr('type', 'hidden')
                        .attr('name', 'DeletedFileIds')
                        .val(fileId);
                    $('form').append(deletedFilesInput);
        };
        $("#downloadasExcelforOneUser").click(function () {
                event.preventDefault();
                var id = $('#Id').val();
                $.ajax({
                     url: '@Url.Action("DocstoExcelforOneUser", "NgoaiVSP")',
                     type: 'Get',

                     //contentType:'application/json',
                     data: { Id: id },
                     success: function (res) {
                         //reload attachment list here
                         var url = '@Url.Action("DocstoExcelforOneUser", "NgoaiVSP")';
                         url += '?id=' + id + '';
                         window.location.href=url;
                     },
                     error: function (err) {
                         console.log(err);
                     }
                });
           });
    </script>
}
